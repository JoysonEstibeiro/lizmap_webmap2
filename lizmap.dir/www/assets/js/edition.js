/*! For license information please see edition.js.LICENSE.txt */
(()=>{"use strict";function e(){this.message=""}!function(){function e(e,t,i){this.layerId=e,this.config=null,this.feature=t,this.relation=i,this.parent=null,this.backToParent=!1,this.newfeatures=[],this.pivot=null}function t(){this.spatial=!1,this.drawControl=null,this.submitActor="submit",this.ol=null,this.currentFeature=null,this.splitOl=null,this.olStyleCustomRules=[],this.splitOlStyleCustomRules=[]}window.addEventListener("beforeunload",(e=>{lizMap.editionPending&&(e.preventDefault(),e.returnValue="")})),e.prototype={setParentToEditAfterSave:function(e){this.backToParent=!!e,this.parent=e},get geometryType(){return this.config?this.config.geometryType:""}},t.prototype={get config(){return this.currentFeature.config},get geometryType(){return this.currentFeature&&this.currentFeature.config?this.currentFeature.config.geometryType:""},get newfeatures(){return this.currentFeature.newfeatures},get id(){return this.currentFeature.layerId},get parent(){return this.currentFeature.parent},get projCode(){return this.ol.projection.projCode},deactivateControl:function(){this.drawControl&&this.drawControl.active&&this.drawControl.deactivate()},clearLayers:function(){this.ol&&this.ol.destroyFeatures(),this.splitOl&&this.splitOl.destroyFeatures()},clear:function(){this.currentFeature=null,this.spatial=!1,this.drawControl=null,this.submitActor="submit",this.clearLayers()},createLayers:function(){var e,t;0==n.getLayersByName("editSplitLayer").length&&((e=new OpenLayers.Style).addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:6},Line:{strokeWidth:4,fillColor:"#1353ac",strokeColor:"#d6eeff"},Polygon:{strokeWidth:2}}})]),this.splitOlStyleCustomRules.length&&e.addRules(this.splitOlStyleCustomRules),t=new OpenLayers.StyleMap({default:e}),this.splitOl=new OpenLayers.Layer.Vector("editSplitLayer",{styleMap:t}),n.addLayer(this.splitOl)),0==n.getLayersByName("editLayer").length&&((e=new OpenLayers.Style).addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:6},Line:{strokeWidth:4},Polygon:{strokeWidth:2}}})]),this.olStyleCustomRules.length&&e.addRules(this.olStyleCustomRules),t=new OpenLayers.StyleMap({default:e}),this.ol=new OpenLayers.Layer.Vector("editLayer",{styleMap:t}),n.addLayer(this.ol))},getFeature:function(){return this.spatial&&this.ol&&0!=this.ol.features.length?this.ol.features[0]:null},removeEditedFeature:function(e){this.ol.removeFeatures([e])},moveEditedFeatureToSplitLayer:function(e,t){this.ol.removeFeatures([e]),this.splitOl.addFeatures([e]),this.currentFeature.newfeatures.push([e,t])},setDrawControl:function(e){this.drawControl=e,this.spatial=!0},replaceFeature:function(e){this.clearLayers(),this.ol.addFeatures([e])},canEditParentFeature:function(){return null!=this.currentFeature.parent&&this.currentFeature.backToParent},restoreSplitFeatures:function(){var e=this.splitOl;e.destroyFeatures();var t=this.currentFeature.newfeatures.map((function(e){return e[0]}));t.length&&e.addFeatures(t)}};var i=null,n=null,o=null,r=null,a=new t,l=null,d=null;function s(){var e=$("#lizmap-edition-message");0!=e.length&&e.remove(),d=null}function c(e,t,i){d&&(window.clearTimeout(d),d=null);var n=$("#lizmap-edition-message");0!=n.length&&n.remove(),lizMap.addMessage(e,t,i).attr("id","lizmap-edition-message"),d=window.setTimeout(s,5e3)}function u(e){var t=e.features,i=a.geometryType,n=null;"line"==i?n=t[0].geometry.getLength()<t[1].geometry.getLength()?t[0]:t[1]:"polygon"==i&&(n=t[0].geometry.getArea()<t[1].geometry.getArea()?t[0]:t[1]),n&&a.removeEditedFeature(n);var o=a.getFeature();return o&&j(o),$("#edition-geomtool-nodetool").click(),!1}function p(e){var t=$("#edition-form-container form");return"ok"!==T(t)?(c(lizDict["edition.splitfeat.form.error"],"error",!0),!1):!!t.attr("data-new-feature-action")||(c(lizDict["edition.splitfeat.tech.error"],"error",!0),!1)}function f(e){var t=e.features,i=a.geometryType,n=null;if("line"==i?n=t[0].geometry.getLength()<t[1].geometry.getLength()?t[0]:t[1]:"polygon"==i&&(n=t[0].geometry.getArea()<t[1].geometry.getArea()?t[0]:t[1]),n){var o=$("#edition-form-container form"),r=o.find('input[name="liz_geometryColumn"]').val(),l="",d=new FormData(o.get(0));if("set"in d)d.set("liz_featureId",""),d.set("__JFORMS_TOKEN__",""),r&&(l=k(n),d.set(r,l));else{var s=o.find('input[name="liz_featureId"]'),c=o.find('input[name="'+r+'"]'),u=o.find('input[name="__JFORMS_TOKEN__"]'),p=s.val(),f=c.val(),m=u.val();s.val(""),u.val(""),r&&(l=k(n),c.val(l)),d=new FormData(o.get(0)),s.val(p),c.val(f),u.val(m)}a.moveEditedFeatureToSplitLayer(n,d)}var y=a.getFeature();return y&&j(y),$("#edition-geomtool-nodetool").click(),!1}function m(){$("#edition-point-coord-crs-layer").html(lizDict["edition.point.coord.crs.layer"]).val("").hide(),$("#edition-point-coord-crs-map").html(lizDict["edition.point.coord.crs.map"]).val("").hide(),$("#edition-point-coord-x").val(""),$("#edition-point-coord-y").val(""),$("#edition-point-coord-geolocation").is(":checked")&&$("#edition-point-coord-geolocation").click(),$("#edition-point-coord-add").hide(),$("#edition-segment-length").parents(".control-group").addClass("hidden"),$("#edition-segment-angle").parents(".control-group").addClass("hidden"),lizMap.events.triggerEvent("lizmapeditiondrawfeaturedeactivated",{layerId:a.id,editionConfig:a.config})}function y(){var e=$("#edition-form-container form"),t=e.find('input[name="liz_srid"]').val();""==t||"EPSG:"+t in Proj4js.defs||(Proj4js.defs["EPSG:"+t]=e.find('input[name="liz_proj4"]').val()),$("#edition-point-coord-crs-layer").html(lizDict["edition.point.coord.crs.layer"]+" - EPSG:"+t).val(t).show();var i=a.projCode.replace("EPSG:","");$("#edition-point-coord-crs-map").html(lizDict["edition.point.coord.crs.map"]+" - EPSG:"+i).val(i).show(),"point"==a.geometryType?$("#edition-point-coord-add").hide():$("#edition-point-coord-add").show(),$("#handle-point-coord").show(),lizMap.events.triggerEvent("lizmapeditiondrawfeatureactivated",{layerId:a.id,editionConfig:a.config,drawControl:a.drawControl})}function g(){var e=parseFloat($("#edition-point-coord-x").val()),t=parseFloat($("#edition-point-coord-y").val());if(!isNaN(e)&&!isNaN(t)){var i=new OpenLayers.Geometry.Point(e,t),n=$("#edition-point-coord-crs").val();i.transform("EPSG:"+n,a.ol.projection);var o=a.geometryType;if(r[o].handler.point)r[o].handler.point.geometry.x=i.x,r[o].handler.point.geometry.y=i.y,r[o].handler.point.geometry.clearBounds(),M(r[o].handler.layer.features[0].geometry);else{var l=r[o].handler.layer.getViewPortPxFromLonLat({lon:i.x,lat:i.y});r[o].handler.createFeature(l),r[o].handler.point.geometry.x=i.x,r[o].handler.point.geometry.y=i.y,r[o].handler.point.geometry.clearBounds()}r[o].handler.drawFeature()}}function v(e){var t=[e];if("relations"in i)for(var n in i.relations)if(n==e){var o=i.relations[e];for(var r in o){var a=o[r];-1==$.inArray(a.referencingLayer,t)&&t.push(a.referencingLayer)}}else if("pivot"==n&&e in i.relations.pivot){var l=i.relations.pivot[e];for(var d in l)-1==$.inArray(d,t)&&t.push(d)}else{if(-1!=$.inArray(n,t))continue;for(var r in o=i.relations[n])(a=o[r]).referencingLayer==e&&t.push(n)}for(;t.length>0;){r=t.shift();var s=lizMap.getLayerConfigById(r,i.layers,"id");if(!s)continue;var c=s[0];if(!("geometryType"in(s=s[1]))||"none"==s.geometryType)continue;const e=lizMap.mainLizmap.map.getLayerByName(c);void 0!==e&&e.getVisible()&&e.getSource().changed()}return[]}function h(){lizMap.mainLizmap.newOlMap=!0,lizMap.editionPending=!1,$("#mapmenu .edition").removeClass("edition-pending"),r&&(a.deactivateControl(),$("#edition-geomtool-container button i").removeClass("line"),$("#edition-geomtool-container").hide(),r.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE,r.modify.createVertices=!0,r.panel.deactivate()),$("#lizmap-edition-message").remove(),$("#edition-children-container").hide().html(""),$("#edition-form-container").hide().html(""),$("#edition-waiter").hide(),z()?$("#edition-creation").show():($("#edition-modification-msg").show(),$("#dock-close").click()),$(".edition-tabs").hide(),$('.edition-tabs a[href="#tabdigitization"]').show()}function z(){if("editionLayers"in i)for(const e in i.editionLayers)if("True"===i.editionLayers[e].capabilities.createFeature)return!0;return!1}OpenLayers.Geometry.pointOnSegment=function(e,t){return!(e.x<Math.min(t.x1,t.x2)||e.x>Math.max(t.x1,t.x2)||e.y<Math.min(t.y1,t.y2)||e.y>Math.max(t.y1,t.y2))&&(t.x1==t.x2||t.y1==t.y2||e.x==t.x1&&e.y==t.y1||e.x==t.x2&&e.y==t.y2||((t.x1-e.x)/(t.y1-e.y)).toFixed(5)==((t.x2-e.x)/(t.y2-e.y)).toFixed(5))};const L=e=>new Promise(((t,i)=>{setTimeout((e=>t()),e)}));function F(e){var t=$("#edition-point-coord-crs").val(),i=new OpenLayers.Projection("EPSG:"+t);e.transform(a.ol.projection,i),"degrees"===i.getUnits()?($("#edition-point-coord-x").val(e.x.toFixed(6)),$("#edition-point-coord-y").val(e.y.toFixed(6))):($("#edition-point-coord-x").val(e.x.toFixed(3)),$("#edition-point-coord-y").val(e.y.toFixed(3)))}function b(e,t,i){$("#edition-segment-length").parents(".control-group").removeClass("hidden");const n=e.length,o=new OpenLayers.Geometry.LineString([e[n-2],e[n-1]]).getGeodesicLength(t);if(i){let i=0;if(n>1)for(let o=0;o<n-1;o++)i+=new OpenLayers.Geometry.LineString([e[o],e[o+1]]).getGeodesicLength(t);else i=o;$("#edition-segment-length").text(o.toFixed(3)+" / "+i.toFixed(3))}else $("#edition-segment-length").text(o.toFixed(3));lizMap.mainLizmap.edition.lastSegmentLength=o.toFixed(3)}function w(e,t,i){$("#edition-segment-angle").parents(".control-group").removeClass("hidden");const n=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),o=Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2)),r=Math.sqrt(Math.pow(i.x-e.x,2)+Math.pow(i.y-e.y,2));let a=180*Math.acos((o*o+n*n-r*r)/(2*o*n))/Math.PI;isNaN(a)&&(a=0),$("#edition-segment-angle").text(a.toFixed(2))}function M(e){if("OpenLayers.Geometry.LineString"===e.CLASS_NAME&&e.components&&e.components.length>1){const t=e.components,i=t.length;b(t,a.ol.projection,!0),i>2&&w(t[i-1],t[i-2],t[i-3])}else if("OpenLayers.Geometry.Polygon"===e.CLASS_NAME&&e.components&&e.components[0].components.length>2){const t=e.clone().components[0].components;t.pop();const i=t.length;b(t,a.ol.projection,!1),i>2&&w(t[i-1],t[i-2],t[i-3])}}function C(t,n,o,r){var l=new e(t,null,null),d=null;if(null!=o&&"layerId"in o&&"feature"in o){var s=o.layerId,c=o.feature,u=o.pivotId;if("relations"in i&&s in i.relations){var p=function(e,t,n){if("relations"in i&&e in i.relations)if(n){const a=lizMap.getLayerConfigById(n,lizMap.config.attributeLayers,"layerId");if(a&&"True"==a[1]?.pivot){var o=i.relations.pivot[n];if(o){var r=!0;if(Object.keys(o).forEach((o=>{r&&(o==e||o==t?0==(i.relations[o]||[]).filter((e=>e.referencingLayer==n)).length&&(r=!1):r=!1)})),r)return o}}}else{var a=i.relations[e];for(var l in a){var d=a[l];if(d.referencingLayer==t)return d}}return null}(s,t,u);if(null!=p&&(u||p.referencingLayer==t)){if(lizMap.editionPending&&a.id==s){var f=$('#edition-form-container form input[name="liz_featureId"]').val();$('#edition-form-container form input[name="liz_layerId"]').val()==s&&f==c.id.split(".").pop()&&((d=a.currentFeature).relation=p,d.feature=c,u&&(d.pivot=u),l.setParentToEditAfterSave(d),h())}d||(d=new e(s,c,p),u&&(d.pivot=u),l.parent=d)}}}return x(l,n,r)}function _(){var e=a.parent;return x(e,e.feature.id.split(".").pop())}async function x(e,t,n){if(lizMap.editionPending){if(document.querySelector("li.edition:not(.active) #button-edition")?.click(),await L(10),!confirm(lizDict["edition.confirm.cancel"]))return!1;h()}if(a.clear(),!("editionLayers"in i))return!1;if(!r)return!1;lizMap.editionPending=!0,$("#mapmenu .edition").addClass("edition-pending"),a.createLayers();var o=lizMap.getLayerConfigById(e.layerId,i.editionLayers,"layerId");if(!o)return lizMap.editionPending=!1,$("#mapmenu .edition").removeClass("edition-pending"),!1;e.config=o[1],a.currentFeature=e;var d=e.geometryType;return d in r&&a.setDrawControl(r[d]),function(e,t){$("#edition-waiter").show(),$("#edition-form-container").hide(),l=e?"modifyFeature":"createFeature";var i=$("#edition-form-container form");0!=i.length&&i.unbind("submit");var n=Object.assign({},globalThis.lizUrls.params,{layerId:a.id});e&&(n.featureId=e);var o=globalThis.lizUrls.edition+"?"+new URLSearchParams(n);fetch(o.replace("getFeature",l)).then((e=>e.ok?e:Promise.reject("Invalid response: "+e.status+" "+e.statusText))).then((e=>{const t=e.headers.get("Content-Type")||"";return t.includes("text/plain")?e.text():Promise.reject("Invalid response content: "+t)})).then((i=>!!r&&!!a.id&&($("#edition-modification-msg").hide(),$("#edition-creation").hide(),$(".edition-tabs").show(),P(i),lizMap.mainLizmap.newOlMap=!1,void(t&&t(a.id,e))))).catch((e=>{console.error(e),h(),c(lizDict["edition.message.error.fetch.form"],"error",!0)}))}(t,n),a.restoreSplitFeatures(),$("#bottom-dock").trigger("mouseleave"),!0}function S(e){var t=$("<span>").addClass("custom-autocomplete").insertAfter(e),i=e.children(":selected"),n=i.val()?i.text():"",o=$("<input>").appendTo(t).val(n).attr("title","").addClass("custom-autocomplete-input").autocomplete({source:function(t,i){let n=t.term?t.term.normalize("NFD").replace(/[\u0300-\u036f]/g,""):t.term;var o=new RegExp($.ui.autocomplete.escapeRegex(n),"i");i(e.children("option").map((function(){let e=$(this).text();if(e=e.normalize("NFD").replace(/[\u0300-\u036f]/g,""),this.value&&(!n||o.test(e)))return{label:e,value:e,option:this}})))}});o.autocomplete("widget").css("z-index","1050"),o.autocomplete("option","delay",300),o.autocomplete("option","minLength",3),o.attr("name",e.attr("name")),e.attr("name",o.attr("name")+"_source"),e.hide()}function P(e){var t=$("#edition-form-container form").serializeArray(),n=$("#edition-form-container");n.html(e);var d,s=$("#edition-form-container form#jforms_view_edition");if(0!=s.length){s.serializeArray();var u=s.find('input[name="liz_featureId"]').val();if(l=u?"modifyFeature":"createFeature",a.spatial&&"modifyFeature"==l){var p=s.find('input[name="liz_geometryColumn"]').val();if(""!=p){var f=s.find('input[name="'+p+'"]').val();$('#edition-hidden-form input[name="liz_wkt"]').val(f)}}if(null!=a.parent){var m=a.parent,y=m.relation,g=y.referencingField,z=m.feature.properties[y.referencedField],L=m.pivot;if(L&&"createFeature"==l){var F=i.relations[m.layerId].filter((e=>e.referencingLayer==L))[0]?.referencedField;if(F){var b=lizMap.getLayerConfigById(m.layerId);if(b[1]){var w=$('<input type="hidden"></input>').attr("id",L+"_hidden").attr("name","liz_pivot").attr("value",L+":"+m.layerId+":"+m.feature.properties[F]);s.find("div.jforms-hiddens").append(w);var M='<div class="control-group"><p id="edition-link-pivot">'+lizDict["edition.link.pivot.add"].replace("%f","<b>"+m.feature.properties[F]+"</b>").replace("%l","<b>"+b[1].title+"</b>")+"</p></div>";s.find(".control-group").last().append(M)}}}else{var C=s.find('select[name="'+g+'"]');if(1==C.length){C.val(z).change();let e=$('<input type="text" disabled value="'+$("select[name="+g+"] option:selected").html()+'" />');C.parent().append(e),C.addClass("hide")}else{var x=s.find('input[name="'+g+'"]');1==x.length&&"hidden"!=x.attr("type")?(x.val(z).attr("disabled","disabled"),w=$('<input type="hidden"></input>').attr("id",x.attr("id")+"_hidden").attr("name",g).attr("value",z),s.find("div.jforms-hiddens").append(w),jFormsJQ.getForm($("#edition-form-container form").attr("id")).getControl(g).required=!1):x.val(z)}}}for(var k=s.find("select.combobox:not(:disabled)"),R=0,A=k.length;R<A;R++)(d=$(k[R])).combobox({minLength:1,position:{my:"left bottom",position:"flip"},selected:function(e,t){if(t.item){var i=$(this),n=$(t.item);window.setTimeout((function(){i.val(n.val()).change()}),1)}}}),d.parent().find("span > input").removeClass("label ui-corner-left ui-state-default ui-widget-content ui-widget");var D=s.find("select.autocomplete:not(:disabled)");for(R=0,A=D.length;R<A;R++)S($(D[R]));if("0"==s.find('input[name="liz_status"]').val()){if(0!=t.length){var G=a.id,N="lizmapeditionfeaturecreated";"modifyFeature"==l&&(N="lizmapeditionfeaturemodified"),lizMap.events.triggerEvent(N,{layerId:G}),v(G)}var V=a.geometryType;let e=I();if("createFeature"!=l&&e)"True"==a.config.capabilities.modifyGeometry&&V in r?(e=function(){var e=I();return null==e&&(e=new OpenLayers.Feature.Vector),e.fid=$("#edition-form-container form").find('input[name="liz_featureId"]').val(),a.replaceFeature(e),e}(),e&&(r.modify.activate(),$("#edition-geomtool-nodetool").click(),r.modify.selectFeature(e),"line"==V&&$("#edition-geomtool-container button i").addClass("line"),"point"!=V&&$("#edition-geomtool-container").show())):$('.edition-tabs a[href="#tabdigitization"]').hide(),c(lizDict["edition.select.modify.activate"],"info",!0);else if(("True"==a.config.capabilities.createFeature||!e&&"True"==a.config.capabilities.modifyGeometry)&&V in r){$("#edition-geomtool-container button i").removeClass("line"),$("#edition-geomtool-container").hide(),r.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE,r.modify.createVertices=!0,r.modify.deactivate(),a.clearLayers();var B=r[V];B.active||(B.activate(),lizMap.checkMobile()?c(lizDict["edition.draw.activate.mobile"],"info",!0):c(lizDict["edition.draw.activate"],"info",!0)),e&&(a.ol.addFeatures([e]),r.modify.activate(),$("#edition-geomtool-nodetool").click(),r.modify.selectFeature(e),"line"==V&&$("#edition-geomtool-container button i").addClass("line"),"point"!=V&&$("#edition-geomtool-container").show())}else $('.edition-tabs a[href="#tabdigitization"]').hide()}n.show(),0==s.children("ul.nav-tabs").find("li").filter((function(){return"none"!==$(this).css("display")})).length?$("#"+s.attr("id")+"-tab-content").hide():s.children("ul.nav-tabs").find("li:first a").click().blur(),function(e){var t=jFormsJQ.getForm(e.attr("id"));if(t.groupDependencies)for(var i=t.groupDependencies,n=0,o=i.length;n<o;n++){var r=i[n],a=e.find("#"+e.attr("id")+"_"+r);0!=a.length&&a.change((function(){E(e)}))}}(s),$("#"+s.attr("id")+"_liz_future_action_label").removeClass("control-label"),function(e){a.submitActor="submit",e.find('input[type="submit"]').click((function(t){var i=e.attr("id")+"__submit_",n=$(this).attr("id").replace(i,"");if(a.submitActor=n,"cancel"==n)return t.stopPropagation(),confirm(lizDict["edition.confirm.cancel"])&&P(""),!1}));var t=a.getFeature();t&&j(t),e.submit((function(t){if("cancel"==a.submitActor)return h(),a.canEditParentFeature()?_():(a.clear(),lizMap.events.triggerEvent("lizmapeditionformclosed")),!1;var i=T(e,t);if(!1===i)return!1;if("ok"!=i)return c(i,"info",!0),!1;var n=e.attr("id")+"__submit";$("#"+n).val(a.submitActor),$("#edition-waiter").show();var o=e.attr("data-new-feature-action"),r=e.attr("action"),l=new FormData(e.get(0)),d="",s=O(r,l);return s.then((function(e){d=e})).catch((e=>{console.error(e),$("#edition-waiter").hide(),c(lizDict["edition.message.error.send.feature"],"error",!0)})),a.newfeatures.forEach((function(e){s=s.then((()=>O(o,e[1])))})),s.then((()=>{P(d)})),!1}))}(s),lizMap.events.triggerEvent("lizmapeditionformdisplayed",{layerId:a.id,featureId:u,editionConfig:a.config})}if(0==s.length){o.edition.deactivate(),o.edition.activate();let t=a.id,i="",n=null;if(""!=e){const t=document.querySelector("#edition-form-container form.liz_close_feature_form");if(t){const e=t.querySelector("input#liz_close_feature_pk_vals").value;try{n=JSON.parse(e),t.parentNode.removeChild(t)}catch(e){console.error(e)}}e.includes('<ul class="jelix-msg">')&&(i=e)}N="lizmapeditionfeaturecreated","modifyFeature"==l&&(N="lizmapeditionfeaturemodified"),lizMap.events.triggerEvent(N,{layerId:t,primaryKeys:n}),v(t),h(),""!=i&&c(i,"info",!0)}$("#edition-waiter").hide(),$("li.edition:not(.active) #button-edition").click(),$("#liz_layer_popup_close").length&&$("#liz_layer_popup_close").click(),$("#mapmenu .nav-list > li.popupcontent > a").length&&$("#mapmenu .nav-list > li.popupcontent").hasClass("active")&&($("#button-popupcontent").click(),$("div.lizmapPopupContent").remove()),0==s.length&&(a.canEditParentFeature()?_():(a.clear(),lizMap.mainLizmap.map.clearHighlightFeatures(),lizMap.events.triggerEvent("lizmapeditionformclosed")))}function E(e){const t=jFormsJQ.getForm(e.attr("id")),i=new FormData(t.element),n=new FormData;n.append("__form",t.selector),n.append("__formid",t.formId),n.append("__JFORMS_TOKEN__",i.get("__JFORMS_TOKEN__"));for(const e of t.groupDependencies)for(const t of i.getAll(e))n.append(e,t);fetch(jFormsJQ.groupVisibilitiesUrl,{method:"POST",body:n}).then((function(e){return e.json()})).then((function(t){for(var i in t){var n=$("#"+i);if(n.hasClass("tab-pane")){var o=e.children("ul.nav-tabs").find('li a[href="#'+i+'"]'),r=o.parent();if(t[i]){r.is(":visible")||r.show();var a=$("#"+e.attr("id")+"-tab-content");a.is(":hidden")&&(a.show(),o.click().blur())}else r.hasClass("active")?r.prev(":visible").length>0?(r.prev().children("a").first().click().blur(),r.hide()):r.next(":visible").length>0?(r.next().children("a").first().click().blur(),r.hide()):(r.hide(),$("#"+e.attr("id")+"-tab-content").hide()):r.hide()}else t[i]?n.show():n.hide()}}))}function O(e,t){return new Promise((function(i,n){var o=new XMLHttpRequest;o.open("POST",e),o.onload=function(){200==o.status?i(o.responseText):n(new Error("Nouveau message d'erreur",{cause:o}))},o.addEventListener("error",n),o.addEventListener("abort",n),o.send(t)}))}function T(e,t){if(t){if(!jFormsJQ._submitListener(t))return!1}else if(e.trigger("jFormsUpdateFields"),!jFormsJQ.verifyForm(e.get(0)))return!1;var i="ok";if(a.spatial&&"allow_without_geom"in a.config.capabilities&&"False"==a.config.capabilities.allow_without_geom){var n=e.find('input[name="liz_geometryColumn"]').val();""==e.find('input[name="'+n+'"]').val().trim()&&(i=lizDict["edition.message.error.no.geometry"])}return i}function k(e){if(null==e.geometry)return"";if(!a.ol)return"";var t=e.geometry.clone(),i=$("#edition-form-container form"),n=i.find('input[name="liz_srid"]').val();return""==n||"EPSG:"+n in Proj4js.defs||(Proj4js.defs["EPSG:"+n]=i.find('input[name="liz_proj4"]').val()),t.transform(a.ol.projection,"EPSG:"+n),t}function j(e){var t=k(e);if(""===t)return!1;var i=$("#edition-form-container form"),n=i.find('input[name="liz_srid"]').val();""==n||"EPSG:"+n in Proj4js.defs||(Proj4js.defs["EPSG:"+n]=i.find('input[name="liz_proj4"]').val());var o=i.find('input[name="liz_geometryColumn"]').val();i.find('input[name="'+o+'"]').val(t).change();var r=i.find('input[name="liz_featureId"]').val(),a=i.find('input[name="liz_layerId"]').val();return lizMap.events.triggerEvent("lizmapeditiongeometryupdated",{layerId:a,featureId:r,geometry:t,srid:n}),!0}function I(){if(!a.ol)return null;var e=$("#edition-form-container form"),t=e.find('input[name="liz_geometryColumn"]').val(),i=e.find('input[name="liz_srid"]').val();if(""==i||"EPSG:"+i in Proj4js.defs||(Proj4js.defs["EPSG:"+i]=e.find('input[name="liz_proj4"]').val()),""!=t){var n=e.find('input[name="'+t+'"]').val();if(""!=n)return new OpenLayers.Format.WKT({externalProjection:"EPSG:"+i,internalProjection:a.ol.projection}).read(n)}return null}lizMap.events.on({uicreated:()=>{i=lizMap.config,lizMap.layers,n=lizMap.map,o=lizMap.controls;var e={addStyleRulesToSplitLayers:function(e){a.splitOlStyleCustomRules=a.splitOlStyleCustomRules.concat(e)},addStyleRulesToEditLayers:function(e){a.olStyleCustomRules=a.olStyleCustomRules.concat(e)}};lizMap.events.triggerEvent("lizmapeditionfeatureinit",{editorOptions:e}),function(){if("editionLayers"in i){var e={},t=[];for(var l in i.editionLayers){var d=i.editionLayers[l];if("False"!=d.capabilities.createFeature||"False"!=d.capabilities.modifyAttribute||"False"!=d.capabilities.deleteFeature||"False"!=d.capabilities.modifyGeometry){if(l in i.layers&&"True"==d.capabilities.createFeature){var s=i.layers[l];e[d.order]={id:s.id,title:s.title,order:d.order},t.push(d.order)}}else delete i.editionLayers[l]}for(var v in t.sort((function(e,t){return e-t})),t)s=e[t[v]],$("#edition-layer").append('<option value="'+s.id+'">'+s.title+"</option>");z()?$("#edition-modification-msg").hide():$("#edition-creation").hide(),a.createLayers();var b=a.ol;for(var w in r={panel:new OpenLayers.Control({type:OpenLayers.Control.TYPE_TOOL,eventListeners:{activate:function(e){lizMap.deactivateToolControls(e)},deactivate:function(e){for(var t in r)"panel"!=t&&r[t].active&&r[t].deactivate()}}}),point:new OpenLayers.Control.DrawFeature(b,OpenLayers.Handler.Point,{eventListeners:{activate:y,deactivate:m}}),line:new OpenLayers.Control.DrawFeature(b,OpenLayers.Handler.Path,{eventListeners:{activate:y,deactivate:m}}),polygon:new OpenLayers.Control.DrawFeature(b,OpenLayers.Handler.Polygon,{eventListeners:{activate:y,deactivate:m}}),modify:new OpenLayers.Control.ModifyFeature(b),reshape:new OpenLayers.Control.Split({layer:b,eventListeners:{aftersplit:u}}),featsplit:new OpenLayers.Control.Split({layer:b,eventListeners:{beforesplit:p,aftersplit:f}})})"panel"!=w&&r[w].events.on({activate:function(e){e.object.layer.setVisibility(!0)},deactivate:function(e){e.object.layer.setVisibility(!1)}}),n.addControls([r[w]]);o.edition=r.panel,b.events.on({featureadded:function(){if(!r)return!1;var e=a.geometryType,t=r[e].active;t&&r[e].deactivate();var i=b.features[0];j(i),(t||"True"==a.config.capabilities.modifyGeometry)&&(r.panel.activate(),r.modify.activate(),$("#edition-geomtool-nodetool").click(),r.modify.selectFeature(i),"line"===e&&$("#edition-geomtool-container button i").addClass("line"),"point"!==e&&$("#edition-geomtool-container").show()),"point"===e&&($('.edition-tabs a[href="#tabform"]').tab("show"),$("#handle-point-coord").hide()),c(lizDict["edition.select.modify.activate"],"info",!0)},featuremodified:function(e){null!=e.feature.geometry&&j(e.feature)},featureselected:function(e){e.feature.geometry},featureunselected:function(e){null!=e.feature.geometry&&j(e.feature)},sketchmodified:function(e){if($("#edition-point-coord-geolocation").is(":checked")){var[t,i]=lizMap.mainLizmap.geolocation.getPositionInCRS(a.ol.projection);e.vertex.x=t,e.vertex.y=i}else F(e.vertex.clone());M(e.feature.geometry)},vertexmodified:function(e){}}),$("#edition-draw").click((async function(){if($(this).hasClass("disabled"))return!1;if(lizMap.editionPending){if(document.querySelector("li.edition:not(.active) #button-edition")?.click(),await L(10),!confirm(lizDict["edition.confirm.cancel"]))return!1;h(),a.clear()}return r.panel.activate(),C($("#edition-layer").val(),null),!1})),$("#edition-point-coord-form").submit((function(){return!1})),$("#edition-point-coord-crs").change((function(){null!==r[a.geometryType].handler.point&&F(r[a.geometryType].handler.point.geometry.clone())})),$("#edition-point-coord-x").keyup(g),$("#edition-point-coord-y").keyup(g),$("#edition-point-coord-geolocation").change((function(){if($(this).is(":checked")){if($("#edition-point-coord-x").attr("disabled","disabled"),$("#edition-point-coord-y").attr("disabled","disabled"),lizMap.mainLizmap.geolocation.isTracking){var e=a.geometryType,[t,i]=lizMap.mainLizmap.geolocation.getPositionInCRS(a.ol.projection);if(t&&i){var n=r[e].handler.layer.getViewPortPxFromLonLat({lon:t,lat:i});r[e].handler.modifyFeature(n),F(new OpenLayers.Geometry.Point(t,i))}}}else $("#edition-point-coord-x").removeAttr("disabled"),$("#edition-point-coord-y").removeAttr("disabled");lizMap.mainLizmap.geolocation.isLinkedToEdition=$(this).is(":checked")})),$("#edition-point-coord-add").click((function(){var e=a.geometryType;if("point"!=e&&r[e].handler.point){var t=r[e].handler.point.geometry;r[e].handler.insertXY(t.x,t.y)}})),$("#edition-point-coord-submit").click((function(){var e=a.geometryType;r[e].handler.getGeometry()&&("point"===e?(lizMap.mainLizmap.geolocationSurvey.averageRecordMode&&void 0!==lizMap.mainLizmap.geolocationSurvey.positionAverageInMapCRS&&(r[e].handler.point.geometry.x=lizMap.mainLizmap.geolocationSurvey.positionAverageInMapCRS[0],r[e].handler.point.geometry.y=lizMap.mainLizmap.geolocationSurvey.positionAverageInMapCRS[1],r[e].handler.drawFeature()),r[e].handler.finalize()):r[e].handler.finishGeometry())})),$("#edition-geomtool-restart-drawing").click((function(){if(!confirm(lizDict["edition.confirm.restart-drawing"]))return!1;var e=r[a.geometryType];if(e.active)return!1;r.featsplit.deactivate(),r.reshape.deactivate(),r.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE,r.modify.createVertices=!0,r.modify.deactivate(),r.panel.deactivate(),a.clearLayers(),e.activate()})),$("#edition-geomtool-nodetool").click((function(){r.reshape.deactivate(),r.featsplit.deactivate(),r.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE,r.modify.createVertices=!0,r.modify.activate();var e=a.getFeature();e.geometry&&(r.modify.feature&&r.modify.unselectFeature(e),r.modify.selectFeature(e))})),$("#edition-geomtool-drag").click((function(){r.reshape.deactivate(),r.featsplit.deactivate(),r.modify.mode=OpenLayers.Control.ModifyFeature.DRAG,r.modify.createVertices=!1,r.modify.activate();var e=a.getFeature();e&&(r.modify.feature&&r.modify.unselectFeature(e),r.modify.selectFeature(e))})),$("#edition-geomtool-rotate").click((function(){r.reshape.deactivate(),r.featsplit.deactivate(),r.modify.mode=OpenLayers.Control.ModifyFeature.ROTATE,r.modify.createVertices=!1,r.modify.activate();var e=a.getFeature();e&&(r.modify.feature&&r.modify.unselectFeature(e),r.modify.selectFeature(e))})),$("#edition-geomtool-reshape").click((function(){var e=a.getFeature();e&&r.modify.feature&&r.modify.unselectFeature(e),r.modify.deactivate(),r.featsplit.deactivate(),r.reshape.activate()})),$("#edition-geomtool-split").click((function(){var e=a.getFeature();e&&r.modify.feature&&r.modify.unselectFeature(e),r.modify.deactivate(),r.reshape.deactivate(),r.featsplit.activate()})),$("#edition-geomtool-container button, lizmap-reverse-geom").tooltip({placement:"top"}),lizMap.mainEventDispatcher.addListener((()=>{const e=lizMap.mainLizmap.geolocation.isTracking;$("#edition-point-coord-geolocation-group").toggle(e),e?$("#edition-point-coord-geolocation").is(":checked")&&($("#edition-point-coord-x").attr("disabled","disabled"),$("#edition-point-coord-y").attr("disabled","disabled")):($("#edition-point-coord-x").removeAttr("disabled"),$("#edition-point-coord-y").removeAttr("disabled"))}),"geolocation.isTracking"),lizMap.mainEventDispatcher.addListener((()=>{if(a&&"config"in a){$("#edition-point-coord-geolocation").removeAttr("disabled");var e=a.geometryType;if($("#edition-point-coord-geolocation").is(":checked")&&r[e].active){var[t,i]=lizMap.mainLizmap.geolocation.getPositionInCRS(a.ol.projection),n=r[e].handler.layer.getViewPortPxFromLonLat({lon:t,lat:i});r[e].handler.modifyFeature(n),F(new OpenLayers.Geometry.Point(t,i))}}}),"geolocation.position")}else $("#edition").parent().remove(),$("#button-edition").remove(),$("#edition-form-container").hide()}(),lizMap.launchEdition=function(e,t,i,n){return C(e,t,i,n)},lizMap.deleteEditionFeature=function(e,t,n,o){return function(e,t,n,o){if(!("editionLayers"in i))return!1;var r=lizMap.getLayerConfigById(e,i.editionLayers,"layerId");if(!r||"False"==r[1].capabilities.deleteFeature)return!1;var a=r[0],l=i.layers[a];r[0].split(" ").join("_"),"shortname"in l&&""!=l.shortname&&l.shortname;var d=!1,s=!!lizMap.config?.relations?.pivot?.[e];lizMap.config?.relations?.[e]&&(d=lizMap.config.relations[e].some((e=>{const t=lizMap.getLayerConfigById(e.referencingLayer,lizMap.config.attributeLayers,"layerId");return!(!Array.isArray(t)||2!=t.length)&&lizMap.config.relations.pivot&&null!=lizMap.config.relations.pivot[e.referencingLayer]&&"True"==t[1]?.pivot})));var u=lizDict["edition.confirm.delete"];if(n&&(d||s?u=n:u+="\n"+n),!confirm(u))return!1;var p=globalThis.lizUrls.edition+"?"+new URLSearchParams(globalThis.lizUrls.params);return $.get(p.replace("getFeature","deleteFeature"),{layerId:e,featureId:t,linkedRecords:d?"ntom":""},(function(i){c(i,"info",!0),o&&o(e,t),lizMap.events.triggerEvent("lizmapeditionfeaturedeleted",{layerId:e,featureId:t,featureType:a,updateDrawing:!0}),v(e)})),!1}(e,t,n,o)}}})}(),e.prototype={start:function(e){this.message="",this.form=e,$("#"+e.name+" .jforms-error").removeClass("jforms-error"),$("#"+e.name+"_errors").empty().hide()},addError:function(e,t){var i=this.form.element.elements[e.name];i&&i.nodeType&&$(i).addClass("jforms-error");var n=e.name.replace(/\[\]/,"");$("#"+this.form.name+"_"+n+"_label").addClass("jforms-error"),this.message+=1==t?'<p class="error"> '+e.errRequired+"</p>":2==t?'<p class="error"> '+e.errInvalid+"</p>":'<p class="error"> Error on \''+e.label+"' </p>"},end:function(){var e=this.form.name+"_errors",t=document.getElementById(e);""!=this.message?(t||((t=document.createElement("div")).setAttribute("class","jforms-error-list alert alert-block alert-error"),t.setAttribute("id",e),$(this.form.element).first().before(t)),$(t).hide().html(this.message).fadeIn()):t&&$(t).hide()}},window.lizEditionErrorDecorator=e})();
//# sourceMappingURL=edition.js.map